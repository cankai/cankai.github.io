Title: 谈谈TCP/IP协议-上
Date: 2017-08-06 11:20
Category: 网络
Tags: TCP/IP, 网络
Slug: tcpip1
Author: Chen Kai
Summary: TCP/IP 协议是互联网的基础，在工作中总是会遇到各种各样的问题，下面对TCP/IP 协议进行了一些总结。

TCP/IP 协议是互联网的基础，在工作中总是会遇到各种各样的问题，下面对TCP/IP 协议进行了一些总结。TCP/IP协议基本上等同于整个网络协议族，协议中通过分层来工作，以适应不同的网络和不同的业务需求，在分层中，上层协议通过下层协议来工作，下层协议为上层提供服务。下面主要讲传输层的部分，最主要是讲TCP协议。

### 一、TCP 报文格式
TCP报文包括TCP首部和TCP数据，格式如下：
![](https://i.loli.net/2017/08/06/59868e0e7ddf5.png)
* 由图可见，TCP报文不包含IP地址和MAC地址，那是下层协议的事。

* 报文包含了源端口和目的端口号，报文需要通过(srdAddr, srcPort, desAddr, desPort, protocol) 来确定一个连接。

* 32 位序号和32 位确认号，是用来解决乱序和重传问题。

* TCP标志位，来标志报文类型，比如同步报文(SYN)或者应答报文(ACK)，窗口大小用来进行流控，也就是滑动窗口。

TCP将用户数据打包构成报文段;它发送数据后启动一个定时器;另一端对收到的数据进行确认，对失序的数据重新排序，丢弃重复数据;TCP提供端到端的流量控制，并计算和验证一个强制性的端到端检验。

### 二、TCP 连接与状态转换
TCP 通过三次握手来建立连接，并通过四次挥手来断开连接。连接建立和断开的流程图如下：
![3and4.flow.png](https://i.loli.net/2017/08/11/598dadcca14af.png)
首先服务端打开一个端口，处于监听状态，主动连接方发送一个同步数据(SYN)，接收到SYN后，服务端发送下一个SYN执行被动打开，并发送上一个SYN的ACK，接收到SYN后，主动连接方发送最后一个ACK，完成三次握手。
在断开连接时，需要发送四个包来完成整个过程，称之为四次挥手。那么为什么建立连接需要三次握手，而断开需要四次挥手。这主要是因为TCP是一个全双工的通信，在断开的时候，存在一个半关闭的状态。当发送完第一个FIN并被ACK后，双向通信的一个通路被断开。另一个通路依旧可以写数据。如果此时被断方存在数据，就会最后将数据发送出去，有时，被断方没有数据需要发送，就会将ACK并FIN一起发送，表示另外一条通路需要关闭，由此四次挥手可以合并为三次挥手。

通过抓包来验证，如下：
![hand.cap.png](https://i.loli.net/2017/08/11/598da9c50f944.png)
由图可以看到，首先发送一个Seq=0 的 SYN 包，接收到SYN后的下一个ACK的Seq=0 ，表示接收到上一个SYN。通过Seq来一一对应的ACK包，来确定TCP的可靠性。

TCP 状态转移图如下：
![tcp_state_machine.jpg](https://i.loli.net/2017/08/11/598daa0d62993.jpg)
在TCP状态转移图中，有一个状态需要关注(TIME_WAIT)，TIME_WAIT 状态会被保留2MSL时间。MSL代表一个数据报文在链路中的最大存活时间。因为一个IP报文会有一个TTL的概念，超过TTL跳的数据报会被丢失。装换为时间就是MSL，TIME_WAIT的存在有两个意义：
1、保证双向链路的完全断开，假如最后一个ACK丢失了，另外一端会认为FIN N没有被正确接收，于是重新发送FIN，如果此时此端已经完全断开，则会直接会送一个RST。为了确保四次挥手的完全成功，必须保持这个状态。
2、使得老的重复分组在网络中消失。通过2MSL的TIME_WAIT，可以使得迷途的可以消失。
处于TIME_WAIT 状态的端口不能重连接，如果一定要连接，套接字必须设置REUSE选项。
